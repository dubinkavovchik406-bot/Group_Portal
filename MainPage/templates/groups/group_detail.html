{% extends 'base.html' %}

{% block title %}{{ group_object.name }}{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{% url 'group-list' %}" class="btn btn-link text-decoration-none p-0 text-muted small">
        <i class="bi bi-arrow-left"></i> Назад до списку груп
    </a>
</div>

<div class="row g-4">
    {# ЛЕВАЯ КОЛОНКА: Основная информация #}
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm p-4 p-md-5 mb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h1 class="fw-bold m-0">{{ group_object.name }}</h1>

                {# Кнопка обновления: Админ ИЛИ Модератор этой группы #}
                {% if user.is_admin or user.is_moderator and user.group == group_object %}
                    <a href="{% url 'group-update' group_object.pk %}" class="btn btn-outline-primary btn-round px-4">
                        Оновити групу
                    </a>
                {% endif %}
            </div>

            <p class="text-secondary" style="font-size: 1.1rem; line-height: 1.6;">
                {{ group_object.about|default:"Опис групи відсутній." }}
            </p>

            <hr class="my-4" style="opacity: 0.1;">

            {# УПРАВЛЕНИЕ УЧАСТИЕМ #}
            <div class="d-grid text-center">
                {% if user.group == group_object %}
                    <button class="btn btn-success btn-round py-2 shadow-sm disabled mb-2">
                        <i class="bi bi-check2-circle me-1"></i> Ви вже у групі
                    </button>
                    <button type="button" class="btn btn-link text-danger small text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#leaveModal">
                        Покинути спільноту
                    </button>
                {% else %}
                    <button type="button" class="btn btn-primary btn-round py-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#joinModal">
                        Вступити до групи
                    </button>
                {% endif %}
            </div>
        </div>
    </div>

    {# ПРАВАЯ КОЛОНКА: Список участников #}
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-header bg-white border-0 pt-4 px-4">
                <h5 class="fw-bold m-0">Учасники ({{ group_object.members.count }})</h5>
            </div>
            <div class="card-body p-4">
                {# Доступ к списку: Админ или любой участник этой группы #}
                {% if user.is_admin or user.group == group_object %}
                    <ul class="list-unstyled mb-0">
                        {% for member in group_object.members.all %}
                            <li class="mb-3 d-flex align-items-center">
                                <div class="avatar-circle me-3" style="width: 35px; height: 35px; font-size: 0.85rem;">
                                    {{ member.username|first|upper }}
                                </div>
                                <a href="{% url 'user-detail' member.pk %}" class="text-dark text-decoration-none fw-medium small">
                                    {{ member.username }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-lock text-muted mb-2 d-block fs-3"></i>
                        <p class="text-muted small">Список учасників приховано</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# МОДАЛЬНОЕ ОКНО: ВСТУПИТЬ #}
<div class="modal fade" id="joinModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 28px;">
            <div class="modal-body p-5 text-center">
                <div class="mb-4">
                    <div class="d-inline-flex align-items-center justify-content-center bg-primary-subtle text-primary rounded-circle" style="width: 70px; height: 70px;">
                        <i class="bi bi-person-plus-fill fs-2"></i>
                    </div>
                </div>

                <h4 class="fw-bold mb-3">Приєднатися до групи?</h4>

                {# Попередження для модератора #}
                {% if user.is_moderator %}
                    <div class="alert alert-warning border-0 small text-start mb-4" style="border-radius: 15px;">
                        <div class="d-flex">
                            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                            <div>
                                <strong>Увага!</strong> Ви зараз є модератором в іншій групі.
                                При вступі в <strong>"{{ group_object.name }}"</strong> ви автоматично
                                <span class="text-danger fw-bold">втратите статус модератора</span>.
                            </div>
                        </div>
                    </div>
                {% endif %}

                <p class="text-muted mb-4">Ви станете учасником спільноти <strong>"{{ group_object.name }}"</strong> та зможете бачити список її учасників.</p>

                <form action="{% url 'user-join-group' group_object.pk %}" method="post">
                    {% csrf_token %}
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-round py-2 fw-bold shadow-sm">Підтвердити вступ</button>
                        <button type="button" class="btn btn-link text-muted text-decoration-none small" data-bs-dismiss="modal">Скасувати</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 28px;">
            <div class="modal-body p-5 text-center">
                <div class="mb-4">
                    <div class="d-inline-flex align-items-center justify-content-center bg-danger-subtle text-danger rounded-circle" style="width: 70px; height: 70px;">
                        <i class="bi bi-box-arrow-right fs-2"></i>
                    </div>
                </div>

                <h4 class="fw-bold mb-3">Покинути групу?</h4>

                {# Попередження для модератора #}
                {% if user.is_moderator %}
                    <div class="alert alert-danger border-0 small text-start mb-4" style="border-radius: 15px;">
                        <div class="d-flex">
                            <i class="bi bi-shield-slash-fill me-2 fs-5"></i>
                            <div>
                                <strong>Важливо!</strong> Оскільки ви є модератором цієї групи,
                                після виходу ви <span class="fw-bold">втратите свої повноваження</span> модератора назавжди.
                            </div>
                        </div>
                    </div>
                {% endif %}

                <p class="text-muted mb-4">Ви впевнені, що хочете вийти з групи <strong>"{{ group_object.name }}"</strong>?</p>

                <form action="{% url 'user-leave-group' group_object.pk %}" method="post">
                    {% csrf_token %}
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-danger btn-round py-2 fw-bold shadow-sm">Так, вийти з групи</button>
                        <button type="button" class="btn btn-link text-muted text-decoration-none small" data-bs-dismiss="modal">Я залишаюсь</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}